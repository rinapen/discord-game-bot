# Casino Bot

> Discord上で動作するカジノゲームボット（教育・学習目的）

## 重要な法的免責事項

### 必ずお読みください

**このソフトウェアは教育目的および技術学習目的でのみ提供されています。**

1. **法的責任について**
   - 本ソフトウェアの作成者および貢献者は、このソフトウェアの使用によって生じたいかなる損害、法的問題、金銭的損失についても一切の責任を負いません
   - ユーザーは自己の責任において本ソフトウェアを使用するものとします

2. **賭博行為の禁止**
   - **日本国内では刑法第185条により賭博行為は違法です**
   - 実際の金銭を賭ける行為は絶対に行わないでください
   - このボットを実際の金銭取引に使用することは法律違反となる可能性があります

3. **使用上の注意**
   - 本ソフトウェアは技術的な学習教材としてのみ使用してください
   - 実際の金銭を扱う目的での使用は推奨しません
   - お住まいの地域の法律および規制を必ず確認し、遵守してください
   - 未成年者による使用は保護者の監督下でのみ許可されます

4. **地域による法律の違い**
   - 賭博に関する法律は国や地域によって大きく異なります
   - 使用前に必ず地域の法律を確認してください
   - 法律に違反する使用方法は厳禁です

**本ソフトウェアを使用することで、上記の免責事項に同意したものとみなされます。**

---

## 概要

このプロジェクトは、Discord.py を使用したカジノゲームボットの実装例です。

### ゲーム機能

- **コインフリップ** - シンプルな確率ゲーム
- **ダイス** - サイコロゲーム
- **ブラックジャック** - カードゲーム
- **マインズ** - マインスイーパー風ゲーム
- **ヒットアンドブロー** - 数字当てゲーム

### 管理機能

- 残高管理システム
- 送金機能
- 景品交換システム（PNC→景品、直接換金ではない）
- 景品ポケット機能
- 取引履歴
- ランキングシステム
- 統計レポート

## 技術スタック

- **言語**: Python 3.10+
- **フレームワーク**: Discord.py
- **データベース**: MongoDB
- **その他**: 
  - matplotlib (グラフ生成)
  - pytz (タイムゾーン)
  - pymongo (MongoDB接続)

## インストール

### 前提条件

- Python 3.10以上
- MongoDB
- Discord Bot Token

### セットアップ手順

1. **リポジトリのクローン**
```bash
git clone https://github.com/rinapen/casino.git
cd casino
```

2. **仮想環境の作成（推奨）**
```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
```

3. **依存関係のインストール**
```bash
pip install -r requirements.txt
```

4. **環境変数の設定**

`env.example` をコピーして `.env` ファイルを作成：

```bash
cp env.example .env
```

`.env` ファイルを編集して設定：

```env
# ========================================
# 環境モード（重要）
# ========================================
# test: テストモード（PayPay不要、安全）
# production: 本番モード（実際のPayPay接続、危険）
ENVIRONMENT=test

# Discord設定
DISCORD_BOT_TOKEN=your_bot_token_here
GUILD_ID=your_guild_id

# チャンネルID設定
ACCOUNT_CHANNEL_ID=your_account_channel_id
INVITE_PANEL_CHANNEL_ID=your_invite_panel_channel_id
HITANDBLOW_CATEGORY_ID=your_hitandblow_category_id
INFO_PANEL_CHANNEL_ID=your_info_panel_channel_id

CASINO_LOG_CHANNEL_ID=your_casino_log_channel_id
PAYIN_LOG_CHANNEL_ID=your_payin_log_channel_id
PAYOUT_LOG_CHANNEL_ID=your_payout_log_channel_id
EXCHANGE_LOG_CHANNEL_ID=your_exchange_log_channel_id
RANKING_CHANNEL_ID=your_ranking_channel_id
ADMIN_CHANNEL_ID=your_admin_channel_id

# MongoDB設定
MONGO_URI=mongodb://localhost:27017/
DB_NAME=casino_bot

# ロールID設定
PURCHASER_ROLE_ID=your_purchaser_role_id

# 管理者・除外ユーザーID
ADMIN_USER_ID=your_admin_user_id
EXCLUDED_USER_IDS=123456789,987654321

# ========================================
# PayPay設定（本番モード時のみ）
# ========================================
# WARNING: ENVIRONMENT=production の場合のみ設定
# テストモードでは不要・使用されません
# PAYPAY_PHONE_NUMBER=your_phone_number
# PAYPAY_PIN=your_pin
```

### 必須設定項目

以下の項目は必ず設定してください：

- `ENVIRONMENT` - 環境モード（test/production）
- `DISCORD_BOT_TOKEN` - Discordボットのトークン
- `GUILD_ID` - サーバーID
- 各種チャンネルID
- `ADMIN_USER_ID` - 管理者のユーザーID

### オプション設定項目

- `EXCLUDED_USER_IDS` - 統計から除外するユーザーID（カンマ区切り）
  - 例: `123456789,987654321`
  - テストアカウントやボットアカウントを除外する場合に使用

### 環境モードについて

#### テストモード（推奨）

```env
ENVIRONMENT=test
```

**特徴:**
- PayPay接続なし（モックデータを使用）
- 実際の金銭取引は発生しません
- 開発・テストに安全
- PayPay設定不要
- `ADMIN_USER_ID`と`EXCLUDED_USER_IDS`のみで動作

#### 本番モード（非推奨）

```env
ENVIRONMENT=production
```

**注意:**
- 実際のPayPayに接続
- 実際の金銭取引が発生
- 法的リスクあり
- PayPay認証情報が必要
- 使用は自己責任

5. **ボットの起動**

テストモードで起動（推奨）：

```bash
# .env で ENVIRONMENT=test を設定済みの場合
python main.py

# 起動時に以下が表示されます：
# ============================================================
# テストモードで起動しています
#    PayPayは使用されません（モックデータを使用）
# ============================================================
```

本番モードで起動（非推奨・自己責任）：

```bash
# .env で ENVIRONMENT=production を設定
python main.py

# 起動時に以下が表示されます：
# ============================================================
# 本番モードで起動しています
#    実際のPayPayに接続します
# ============================================================
```

## 使用方法

### テストモードの特徴

テストモード（`ENVIRONMENT=test`）では：

**安全性**
- PayPayライブラリが読み込まれません
- 実際の金銭取引は一切発生しません
- 認証情報不要

**開発に最適**
- モックデータで全機能をテスト可能
- 入金・出金の動作確認が安全に実施できます
- エラーが発生しにくい

**簡単な入金処理**
- PayPayリンク不要
- 金額を数字で直接入力
- 即座に残高反映

**法的リスクなし**
- 実際の金銭を扱わないため法的問題が発生しません
- 教育・学習目的に最適

#### テストモードでの入金方法

1. アカウントパネルから「入金」ボタンをクリック
2. モーダルに金額を数字で入力（例: `1000`）
3. 送信すると即座に残高に反映されます

**注意:** テストモードでは実際のPayPayは使用されません。全てモックデータです。

### 景品交換システム

このボットは**直接的な換金ではなく、景品交換方式**を採用しています。

#### 景品の種類

| 景品 | 換金相当額 | 必要PNC（手数料込） |
|------|----------|-----------------|
| 大景品（黄） | ¥5,000 | 57,000 PNC |
| 中景品（青） | ¥1,000 | 11,400 PNC |
| 小景品（緑） | ¥500 | 5,700 PNC |
| アカウント交換券 | ¥80 | 912 PNC |
| 繰越ポイント | - | 余り分 |

#### 使用方法

**ステップ1: 景品交換**
1. `?交換` コマンドを実行
2. 残高 + 繰越ポイントから自動的に景品に振り分け
3. 余りが912 PNC以上の場合：
   - **アカウント交換券と交換** または **繰越ポイントにする** を選択
   - アカウント交換券: ¥80相当のアカウント交換券をポケットに追加
   - 繰越ポイント: 次回の景品交換時に使用可能（アカウント交換には不可）
4. `?ポケット` で景品、アカウント交換券、繰越ポイントを確認

**ステップ2: アカウント引き換え**
1. `?引換` コマンドを実行
2. 所持しているアカウント交換券の個数分、実際のアカウント情報を取得
3. メール・パスワードが**あなたにのみ**表示される（ephemeral）
4. 必ずスクリーンショット等で保存
5. 一度引き換えたアカウントは再取得不可

**重要な仕組み:**
- 繰越ポイントは景品交換時のみ使用可能
- 繰越ポイントはアカウント交換には使えません
- アカウント交換は景品交換時の**余りからのみ**可能

**法的注意:** 景品は法的な金銭価値を持ちません（教育目的のみ）

#### 景品交換の有効化

`.env` ファイルで設定：

```env
EXCHANGE_ENABLED=true  # 有効化
EXCHANGE_ENABLED=false # 無効化（デフォルト）
```

### テキストコマンド

**プレフィックス:** `?`

| コマンド | 説明 | 権限 |
|---------|------|------|
| `?残高` | 現在の残高を確認 | 全員 |
| `?ポケット` | 景品ポケットの中身を確認 | 全員 |
| `?交換` | PNC残高を景品に交換（要EXCHANGE_ENABLED） | 全員 |
| `?引換` | アカウント交換券を実際のアカウントに引き換え | 全員 |
| `?買取 @ユーザー` | 指定ユーザーの景品を全てクリア | スタッフのみ |
| `?送金 @ユーザー [金額]` | 他のユーザーに送金 | 全員 |
| `?フリップ [金額]` | コインフリップゲームを開始 | 全員 |
| `?ダイス [金額]` | ダイスゲームを開始 | 全員 |
| `?bj [金額]` | ブラックジャックを開始 | 全員 |
| `?マインズ [金額] [地雷数]` | マインズゲームを開始 | 全員 |

### スラッシュコマンド

**管理者専用:**
- `/換金率キャンペーン [mode]` - 換金率100%キャンペーンのON/OFF
- `/テーブル作成 [count]` - 指定した数のカジノテーブルチャンネルを作成（DB保存）
- `/テーブル削除 [confirm]` - 全てのカジノテーブルチャンネルを削除（確認: `delete`）
- `/テーブル一覧` - 登録されているテーブルの一覧を表示

### 情報パネルシステム

サーバー情報を整理して表示するインタラクティブなパネルシステムです。

**機能:**
- 再起動時に自動送信
- カテゴリ別情報表示（サーバーについて/ゲームについて/景品について）
- 3段階のセレクトメニュー方式
  1. カテゴリ選択
  2. 詳細項目選択（カテゴリに応じて変化）
  3. トップに戻る
- ページネーション機能（複数ページがある場合）
- Ephemeral表示（本人にのみ見える）

**カテゴリ内容:**

**サーバーについて**
- 利用規約
- 運営情報
- お問い合わせ

**ゲームについて**
- 各ゲームの詳細ルール
- 配当表
- 最小/最大ベット額
- 遊び方

**景品について**
- 管理者への問い合わせ案内

**設定:**
```env
INFO_PANEL_CHANNEL_ID=your_channel_id
```

## プロジェクト構造

```
casino/
├── assets/           # ゲーム用アセット（画像、フォント）
├── commands/         # ゲームコマンド実装
│   ├── balance.py
│   ├── flip.py
│   ├── dice.py
│   ├── blackjack.py
│   ├── mines.py
│   └── ...
├── database/         # データベース接続とモデル
│   └── db.py
├── tasks/           # 定期タスク（ランキング、レポート）
│   └── usage_ranking.py
├── ui/              # DiscordUIコンポーネント
│   ├── buttons.py
│   ├── modals.py
│   └── game/        # ゲーム専用UI
├── utils/           # ユーティリティ関数
│   ├── logs.py
│   ├── pnc.py
│   ├── embed_factory.py
│   └── ...
├── bot.py           # ボットインスタンス
├── config.py        # 設定ファイル
├── main.py          # エントリーポイント
└── README.md
```

## 開発

### コード品質

このプロジェクトは以下のベストプラクティスに従っています：

- 型ヒント（95%カバレッジ）
- ドキュメント文字列
- セクション分けされた構造
- エラーハンドリング
- 定数の外部化

### 推奨開発ツール

```bash
# 型チェック
pip install mypy
mypy .

# コードフォーマット
pip install black
black .

# リンター
pip install ruff
ruff check .
```

## 機能詳細

### Provably Fair システム

一部のゲームでは、Provably Fair（証明可能な公平性）システムを実装しています：

- サーバーシードのハッシュ化
- クライアントシードの使用
- ナンス（nonce）による一意性保証
- HMAC-SHA256による結果生成

### データベーススキーマ

主要なコレクション：

- `users` - ユーザー情報と残高
- `financial_transactions` - 金銭取引履歴（payin、payout、exchange）
- `prize_pockets` - 景品ポケット
- `carry_over_points` - 繰越ポイント
- `accounts` - アカウント情報（引き換え用）
- `exchanged_accounts` - 交換済みアカウント
- `casino_tables` - カジノテーブル管理
- `bet_history` - ベット履歴
- `bot_state` - ボット状態管理
- `invites` - 招待管理

## 設定オプション

### 経済設定（`config.py`）

```python
MIN_INITIAL_DEPOSIT = 100    # 最小入金額
TAX_RATE = 0.1              # 税率 10%
FEE_RATE = 0.05             # 手数料 5%
```

### ゲーム設定

各ゲームの最小ベット額は個別のコマンドファイルで設定されています。

## 貢献

プルリクエストを歓迎します。大きな変更の場合は、まずissueを開いて変更内容を議論してください。

### 貢献ガイドライン

1. コードには適切な型ヒントを追加
2. ドキュメント文字列を記述
3. 既存のコードスタイルに従う
4. テストが可能な場合は追加

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は [LICENSE](LICENSE) ファイルを参照してください。

**ただし、ライセンスの有無に関わらず、各地域の法律を遵守する責任はユーザーにあります。**

## 再度の警告

### このソフトウェアは教育目的です

- 実際の金銭取引には使用しないでください
- 賭博行為は法律で禁止されている地域が多数あります
- 違法行為に使用しないでください
- 作成者は一切の責任を負いません

## サポート

- **Issues**: バグ報告や機能リクエストは [GitHub Issues](https://github.com/rinapen/casino/issues)
- **技術的な質問**: DiscussionsまたはIssuesで

---

**免責事項**: このソフトウェアは「現状のまま」提供され、明示的または黙示的な保証は一切ありません。使用は完全に自己責任で行ってください。作成者および貢献者は、このソフトウェアの使用によって生じたいかなる損害についても責任を負いません。
